<canvas
  id="ctx"
  width="500"
  height="500"
  style="border:1px solid #000000">
</canvas>

<div
  id="chat-text"
  style="width: 500px;height: 100px;overflow-y: scroll"
>
  <div>Hello!</div>
</div>

<form id="chat-form">
  <input id="chat-input" type="text" style="width: 500px" >
</form>

<script src="/socket.io/socket.io.js"></script>
<script>
  const chatText = document.getElementById("chat-text");
  const chatInput = document.getElementById("chat-input");
  const chatForm = document.getElementById("chat-form");
  const ctx = document.getElementById("ctx").getContext("2d");
  ctx.font = "30px Arial"  
  
  //Initialize the connection between client and server
  const socket = io();

  socket.on("newPositions", data => {
    ctx.clearRect(0, 0, 500, 500);

    for (let i = 0; i < data.player.length; i++) {
      ctx.fillText(data.player[i].number, data.player[i].x, data.player[i].y);
    }

    for (let i = 0; i < data.bullet.length; i++) {
      ctx.fillRect(data.bullet[i].x - 5, data.bullet[i].y - 5, 10, 10);
    }
  })

  socket.on("addToChat", (data) => {
    chatText.innerHTML += "<div>" + data + "</div>";
  })

  socket.on("evalAnswer", (data) => {
    console.log(data);
  })

  chatForm.onsubmit = (event) => {
    event.preventDefault();
    if (chatInput.value[0] === "/") {
      socket.emit("evalServer", chatInput.value.slice(1));
    }
    else {
      socket.emit("sendMsgToServer", chatInput.value);
      chatInput.value = "";
    }
  }

  document.onkeydown = event => {
    if (event.code === "ArrowRight") {
      socket.emit("keyPress", {inputId: "right", state:true});
    }
    else if (event.code === "ArrowLeft") {
      socket.emit("keyPress", {inputId: "left", state:true});
    }
    else if (event.code === "ArrowUp") {
      socket.emit("keyPress", {inputId: "up", state:true});
    }
    else if (event.code === "ArrowDown") {
      socket.emit("keyPress", {inputId: "down", state:true});
    }
  }

  document.onkeyup = event => {
    if (event.code === "ArrowRight") {
      socket.emit("keyPress", {inputId: "right", state:false});
    }
    else if (event.code === "ArrowLeft") {
      socket.emit("keyPress", {inputId: "left", state:false});
    }
    else if (event.code === "ArrowUp") {
      socket.emit("keyPress", {inputId: "up", state:false});
    }
    else if (event.code === "ArrowDown") {
      socket.emit("keyPress", {inputId: "down", state:false});
    }
  }

  document.onmousedown = event => {
    socket.emit("keyPress", {inputId: "attack", state: true});
  }

  document.onmouseup = event => {
    socket.emit("keyPress", {inputId: "attack", state: false});
  }

  document.onmousemove = event => {
    const x = -250 + event.clientX - 8;
    const y = -250 + event.clientY - 8;
    const angle = Math.atan2(y, x) / Math.PI * 180;

    socket.emit("keyPress", {inputId: "mouseAngle", state: angle});
  }

</script>